{% extends 'chat/base.html' %}

{% block content %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>


<div class="chat-frame">
    <div class="chat-sub-frame">
            <div class="chat-list">
                {% for c in all_chats %}

                <button
                        {% if c.selected %}
                        class="chat-list-button-selected"
                        {% else %}
                        class="chat-list-button"
                        {% endif %}

                        onclick="window.location.href='{{ c.url }}';">
                    <div class="chat-list-text">
                    {{ c.title }}
                    </div>
                </button>


                <div class="chat-separator">
                </div>
                {% endfor %}
            </div>



            <div class="opened-chat">

                <div class="chat-header">
                    <div class="chat-header-text">
                        {% if chat_name %}
                            {{ chat_name }}
                        {% else %}
                            Выберите чат
                        {% endif %}
                    </div>
                </div>


                <div class="chat-content" id="display-chat">

                </div>

                <div class="chat-input">
                    <form method="POST">
                        {% csrf_token %}
                        {{ form.text }}
                    </form>
                </div>


            </div>
    </div>
</div>
<br>

<script>
var last_message_id = 0;

function chat_update() {
    $.ajax({
        type: 'GET',
        url : "{% url 'get_chat_messages' %}",
        dataType: 'json',
        data: {
        chat_title: '{{ chat_name }}',
        },

        success: function(response){
            if (last_message_id != response.last_message_id) {
                last_message_id = response.last_message_id;

                var container = document.getElementById("display-chat");
                $(container).empty();

                for (var key in response.messages){
                    var temp = response.messages[key].text + "</div>";
                    var temp2 = response.messages[key].time + "</div>";

                    if (response.messages[key].user == '{{ writer }}') {
                        temp = "<div class='my-chat-message'>" + temp + "<div class='my-chat-time'>" + temp2;
                    }
                    else {
                        temp = "<div class='chat-message'>" + temp + "<div class='chat-time'>" + temp2;
                    }
                $(container).append(temp);
                }

            }

            container.scrollTop = container.scrollHeight;
        }
    });
}

chat_update()

window.onload = function() {
    var inputElement = document.getElementById("chat-input");

    if (inputElement) {
        inputElement.focus();
    }
};

    $(document).ready(function(){
        setInterval(function(){
        chat_update();
        },1000);
    });
    </script>

{% endblock %}